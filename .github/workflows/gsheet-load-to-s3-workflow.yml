name: Downloads a Google Spreadsheet file and saves it in an AWS S3 Bucket

on:
  schedule:
    - cron: '0 3 1 * *'
  workflow_dispatch:

jobs:
  download:
    runs-on: ubuntu-20.04

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Download Python dependencies
      run: |
        pip install -r requirements.txt
        pwd
        ls -a

    - name: Download the Spreadsheet file using Google Drive API
      env:
        CREDENTIALS_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
        REPOSITORY_NAME: ${{ vars.REPOSITORY_NAME }}
        FILE_ID: ${{ secrets.GOOGLE_DRIVE_FILE_ID }}
      run: |
        echo "$CREDENTIALS_JSON" > /home/runner/work/${{ vars.REPOSITORY_NAME }}/${{ vars.REPOSITORY_NAME }}/service_account_credentials.json
        python download_file.py

    - id: install-aws-cli
      uses: unfor19/install-aws-cli-action@v1
      with:
        version: 2
        verbose: false
        arch: amd64
        rootdir: ""
        workdir: ""

    - name: AWS credentials configuration
      run: |
        aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws configure set aws_session_token ${{ secrets.AWS_SESSION_TOKEN }}
        aws configure set default.region us-east-1

    - name: Upload the Spreadsheet to the S3 Bucket
      run: |
        aws s3 cp employees-raw-data.xlsx s3://${{ vars.BUCKET_NAME }}/
